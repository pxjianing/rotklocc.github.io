<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<!--<meta name="viewport" content="width=device-width"/>-->
<link href="style.css" rel="stylesheet" type="text/css">
<title>ROTK LoCC - Commanders</title>
<script type="text/javascript" src="js/autocomplete.js"></script>
<script type="text/javascript" src="js/atkShape.js"></script>
<script type="text/javascript" src="js/localizes.js"></script>
<script type="text/javascript" src="js/data.js"></script>
<script type="text/javascript" src="js/rtkcommon.js"></script>
<script type="text/javascript" src="js/utils.js"></script>
<script type="text/javascript">
var maxCost = 0;

var wordlists = []; // wordlists for word filter autocomplete
var usedPassiveIds = [];
var filterUnitTypes = [];
var filterPassives = [];

function popupPassive(td) {
	var passiveList = td.passiveList;
	var passiveId = passiveList['passiveId'];
	var passive = passives[passiveId];
	
	document.getElementById("modalHeader").innerHTML = toLocalizes(passive["name"], " &nbsp; ");
	document.getElementById("modalContent").innerHTML = getHtmlPassiveListDesc(passiveList);
	document.getElementById("modalDiv").style.display = "block";
}

function popupUnitType(td) {
	var unit = td.parentElement.unit;
	var unitType = unitTypes[unit["jobTypeId"]]
	
	document.getElementById("modalHeader").innerHTML = toLocalizes(unitType['name'], " &nbsp; ");
	
	var utypePassives = unitType["job5"]["passives"]
	txt = "";
	txt += '<p class="header">Growth Level</p>';
	txt += '<table class="stats"><tr><th>ATK</th><th>WIS</th><th>DEF</th><th>AGI</th><th>MRL</th></tr>';
	txt += "<tr>";
	txt += "<td>" + unitType["atkLv"] + "</td>";
	txt += "<td>" + unitType["wisLv"] + "</td>";
	txt += "<td>" + unitType["defLv"] + "</td>";
	txt += "<td>" + unitType["agiLv"] + "</td>";
	txt += "<td>" + unitType["mrlLv"] + "</td>";
	txt += "</tr></table>";
	
	txt += '<p class="header">Passives</p>';
	for (var i = 0; i < utypePassives.length; i++) {
		var passive = passives[utypePassives[i][0]];
		var passiveVal = utypePassives[i][1];
		
		txt += "<p><strong>&#x2022; " + toLocalizes(passive["name"], " &nbsp; ") + "</strong></p>";
		txt += "" + getPassiveDescSimple(passive, passiveVal, selLang);
		if (selLang2 !== -1) {
			txt += "<br/>" + getPassiveDescSimple(passive, passiveVal, selLang2);
		}
	}

	txt += '<p class="header">Attack Range</p>';
	txt += getShapeHtml(unitType["job5"]["targetArea"], true);
	
	txt += '<p class="header">Effect Area</p>';
	txt += getShapeHtml(unitType["job5"]["effectArea"], false);
		
	document.getElementById("modalContent").innerHTML = txt;
	document.getElementById("modalDiv").style.display = "block";
}

function popupCommander(td) {
	var unit = td.parentElement.unit;
	
	document.getElementById("modalHeader").innerHTML = toLocalizes(unit['name'], " &nbsp; ");
	
	txt = "";
	txt += '<table class="stats"><tr><th>STR</th><th>INT</th><th>CMD</th><th>DEX</th><th>LCK</th></tr>';
	txt += "<tr>";
	txt += "<td>" + unit["str"] + "</td>";
	txt += "<td>" + unit["int"] + "</td>";
	txt += "<td>" + unit["cmd"] + "</td>";
	txt += "<td>" + unit["dex"] + "</td>";
	txt += "<td>" + unit["lck"] + "</td>";
	txt += "</tr></table>";
	
	txt += "<p>";
	txt += "Banner: " + toLocalizes(banners[unit["bannerId"]], " &nbsp; ") + "<br/>";
	txt += "Gender: " + (unit["gender"] == 'M' ? "Male" : "Female") + "<br/>";
	if (unit["gold"] !== 0) {
		txt += "Gold: " + unit["gold"] + "<br/>";
	}
	txt += "Cost: " + unit["cost"] + "<br/>";
	txt += "Type: " + toLocalizes(unitTypes[unit["jobTypeId"]]["name"], " &nbsp; ");
	txt += "</p>";
	
	
	document.getElementById("modalContent").innerHTML = txt;
	document.getElementById("modalDiv").style.display = "block";
}

function markPassive(passiveId) {
	document.getElementsByName("up"+passiveId).forEach(function(td) {
		td.style.backgroundColor = "palegreen";
	});
}

function unmarkPassive(passiveId) {
	document.getElementsByName("up"+passiveId).forEach(function(td) {
		td.style.backgroundColor = "";
	});
}

function generateTableRows() {
	var tbody = document.getElementById("cbody");
	tbody.innerHTML = "";
	
	wordlists = [];
	usedPassiveIds = [];
	
	for (var typeId in unitTypes) {
		wordlists.push(toLocalize(unitTypes[typeId]["name"]));
	}
	wordlists.sort();
	
	// use object to remove duplication
	var passiveIds = {};
	units.forEach(function(unit) {
		var tr = document.createElement("tr");
		tr.id = unit["id"];
		tr.unit = unit;
		
		var td = createTdHtmlNode('<span class="info" onclick="popupCommander(this.parentNode)">&#x1f6c8;</span>' + toLocalizes(unit["name"]));
		if (unit["gender"] === 'F')
			td.style.backgroundColor = "pink"; // female commander
		tr.appendChild(td);
		
		td = createTdHtmlNode('<span class="info" onclick="popupUnitType(this.parentNode)">&#x1f6c8;</span>' + toLocalizes(unitTypes[unit["jobTypeId"]]['name']));
		tr.appendChild(td);
		
		td = createTdTextNode(unit["cost"]);
		if (unit["gold"] !== 0)
			td.style.backgroundColor = "gold"; // gold commander
		tr.appendChild(td);
		
		for (var i = 0 ; i < unit["passiveListIds"].length; i++) {
			var passiveList = passiveLists[unit["passiveListIds"][i]];
			td = createTdHtmlNode('<span class="info" onclick="popupPassive(this.parentNode)">&#x1f6c8;</span>' + localizePassiveName(passiveList["passiveId"], passiveList["val"]));
			td.passiveList = passiveList;
			td.setAttribute("name", "up"+passiveList["passiveId"]);
			tr.appendChild(td);
			passiveIds[passiveList["passiveId"]] = 0;
		}
				
		tbody.appendChild(tr);
	});
	
	var words = [];
	for (var passiveId in passiveIds) {
		usedPassiveIds.push(Number(passiveId));
		words.push(toLocalize(passives[passiveId]["name"]));
	}
	words.sort();
	wordlists = wordlists.concat(words);
	
	autocomplete(document.getElementById("filterWord"), wordlists, addFilterWord);
	
	filterPassives.forEach(markPassive);

	doFilter();
}

function doFilter() {
	var txt = document.getElementById("filterTxt").value.trim();
	doFilter2(txt);
}

function doFilter2(txt) {
	document.getElementById("content").style.marginTop = (document.getElementById("searchBar").offsetHeight-1) + "px";

	txt = txt.trim();
	
	// quick case
	if (txt === "" && filterUnitTypes.length === 0 && filterPassives === 0 && maxCost !== 0) {
		units.forEach(function(unit) {
			document.getElementById(unit["id"]).style.display = "";
		});
	}
	
	units.forEach(function(unit) {
		// search in all languages
		var tr = document.getElementById(unit["id"]);
		
		if (filterUnitTypes.length !== 0) {
			if (filterUnitTypes.indexOf(unit["jobTypeId"]) === -1) {
				tr.style.display = "none";
				return;
			}
		}
		
		if (maxCost !== 0 && unit["cost"] > maxCost) {
			tr.style.display = "none";
			return;
		}
		
		if (filterPassives.length !== 0) {
			var cnt = 0;
			for (var i = 0; i < unit["passiveListIds"].length; i++) {
				var passiveId = passiveLists[unit["passiveListIds"][i]]["passiveId"];
				if (filterPassives.indexOf(passiveId) !== -1) {
					cnt++;
				}
			}
			// and logic. commander must have all of filter passives
			/*if (cnt !== filterPassives.length) {
				tr.style.display = "none";
				return;
			}*/
			// or logic, commander must have at least one of filter passives
			if (cnt === 0) {
				tr.style.display = "none";
				return;
			}
		}
		
		if (txt === "") {
			tr.style.display = "";
			return;
		}
		
		// search from name
		if (inLocalizeText(unit["name"], txt)) {
			tr.style.display = "";
			return;
		}
		// unit types
		if (inLocalizeText(unitTypes[unit["jobTypeId"]]["name"], txt)) {
			tr.style.display = "";
			return;
		}
		// search from passives
		for (var i = 0; i < unit["passiveListIds"].length; i++) {
			var passive = passives[passiveLists[unit["passiveListIds"][i]]["passiveId"]];
			if (inLocalizeText(passive["name"], txt)) {
				tr.style.display = "";
				return;
			}
		}
		tr.style.display = "none";
	});
}

function changeCost(value) {
	maxCost = Number(value);
	doFilter();
}

function checkSelectValues() {
	document.getElementById("lang").value = selLang;
	document.getElementById("lang2").value = selLang2;
	maxCost = Number(document.getElementById("cost").value);
}

document.addEventListener('DOMContentLoaded', function() {
	// When the user clicks on <span> (x), close the modal
	document.getElementById("closeModal").onclick = function() {
		document.getElementById("modalDiv").style.display = "none";
	}
	
	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function(event) {
		var modal = document.getElementById("modalDiv");
		if (event.target == modal) {
			modal.style.display = "none";
		}
	}
	
	setLangChangeCallback(generateTableRows);
	getUserLangs();
	checkSelectValues();
	generateTableRows();
}, false);

function removeFilterTag(span) {
	if (span.id.startsWith("ut")) {
		typeId = Number(span.id.substr(2));
		var idx = filterUnitTypes.indexOf(typeId);
		if (idx !== -1) { // extra check, should never happen
			span.parentNode.removeChild(span);
			filterUnitTypes.splice(idx, 1);
			// update display
			doFilter();
		}
	}
	else {
		// passive
		passiveId = Number(span.id.substr(1));
		var idx = filterPassives.indexOf(passiveId);
		if (idx !== -1) { // extra check, should never happen
			span.parentNode.removeChild(span);
			filterPassives.splice(idx, 1);
			unmarkPassive(passiveId);
			// update display
			doFilter();
		}
	}
}

function addFilterTag(tagId, tagType, word, idx) {
	var span = document.createElement("span");
	span.setAttribute("id", tagType + tagId);
	span.setAttribute("class", "tag tag-"+tagType);
	span.innerHTML = '<span>' + word + '</span><span class="tag-close" onclick="removeFilterTag(this.parentNode)"> &times; </span>';
	
	document.getElementById("filterTags-"+tagType).append(span);
	
	// update display
	doFilter();
}

function addFilterWord(word) {
	word = word.trim();
	
	wordUpper = word.toUpperCase();
	
	// any language is allowed from manual input. so we have to lookup for every languages
	for (var typeId in unitTypes) {
		typeId = Number(typeId);
		if (hasLocalizeText(unitTypes[typeId]["name"], wordUpper)) {
			if (filterUnitTypes.indexOf(typeId) === -1) {
				filterUnitTypes.push(typeId);
				addFilterTag(typeId, "ut", toLocalize(unitTypes[typeId]["name"]));
			}
			return true;
		}
	}
	
	for (var i = 0; i < usedPassiveIds.length; i++) {
		var passiveId = usedPassiveIds[i];
		var passive = passives[passiveId];
		if (hasLocalizeText(passive["name"], wordUpper)) {
			if (filterPassives.indexOf(passiveId) === -1) {
				filterPassives.push(passiveId);
				addFilterTag(passiveId, "p", toLocalize(passive["name"]));
				markPassive(passiveId);
			}
			return true;
		}
	}
	return false;
}

function addFilterWordBtn() {
	var word = document.getElementById("filterWord").value.trim();
	if (word !== "") {
		if (addFilterWord(word)) {
			document.getElementById("filterWord").value = "";
		}
	}
}

function clearFilters() {
	document.getElementById("filterTxt").value = "";
	document.getElementById("filterWord").value = "";
	document.getElementById("filterTags-ut").innerHTML = "";
	document.getElementById("filterTags-p").innerHTML = "";
	filterUnitTypes = [];
	filterPassives.forEach(unmarkPassive);
	filterPassives = [];
	
	doFilter();
}
</script>
</head>

<body>
<div id="searchBar">
<div id="filterTool" class="topbar">
	<div class="topbar-left">
		Quick Filter: <input type="text" id="filterTxt" tabindex="1" oninput="doFilter()" />
		&nbsp; Max Cost: <select id="cost" tabindex="3" onchange="changeCost(this.value)">
			<option value="0" selected></option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
			<option value="13">13</option>
			<option value="14">14</option>
			<option value="15">15</option>
		</select>
	</div>
	<div class="topbar-right">
	Lang: <select id="lang" onchange="setLang(this.value)">
		<option value="0">KR</option>
		<option value="1">JP</option>
		<option value="2">ZH</option>
		<option value="3">ZH-TW</option>
		<option value="4" selected>EN</option>
		<option value="5">VN</option>
		<option value="6">TH</option>
	</select>
	2nd Lang: <select id="lang2" onchange="setLang2(this.value)">
		<option value="-1"></option>
		<option value="0">KR</option>
		<option value="1">JP</option>
		<option value="2">ZH</option>
		<option value="3">ZH-TW</option>
		<option value="4">EN</option>
		<option value="5">VN</option>
		<option value="6">TH</option>
	</select>
	</div>
</div>
<div id="advanceTool" style="padding-top: 2px">
	<div class="topbar-left">
	  Filter: <div class="autocomplete" style="width:250px;"><input type="text" id="filterWord" style="width:90%;" tabindex="2" placeholder="Unit Type or Passive Name" /></div>
	  <button id="addFilter" onclick="addFilterWordBtn()">Add</button>
	  <button id="clearFilter" onclick="clearFilters()">Clear</button>
	  <p><span id="filterTags-ut"></span><span id="filterTags-p"></span></p>
	</div>
	<div class="topbar-right">
	  <!--<button id="switchView" onclick="">Switch View</button>-->
	</div>
</div>

<div class="table-header">
<table class="table-container">
  <colgroup>
	<col style="width:170px"/>
	<col style="width:160px"/>
	<col style="width:40px"/>
	<col/>
	<col/>
	<col/>
	<col/>
  </colgroup>
  <thead>
	<tr>
	  <th>Name</th>
	  <th>Type</th>
	  <th>Cost</th>
	  <th>Lv30 Passive</th>
	  <th>Lv50 Passive</th>
	  <th>Lv70 Passive</th>
	  <th>Lv90 Passive</th>
	</tr>
  </thead>
</table>
</div>

</div>

<div id="content">

<table id="table-content" class="table-container">
  <colgroup>
	<col style="width:170px"/>
	<col style="width:160px"/>
	<col style="width:40px"/>
	<col/>
	<col/>
	<col/>
	<col/>
  </colgroup>
  <tbody id="cbody">
  </tbody>
</table>
</div>

<!-- Modal box -->
<div id="modalDiv" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<span id="closeModal" class="close">&times;</span>
			<h2 id="modalHeader">Modal Header</h2>
		</div>
		<div class="modal-body">
			<p id="modalContent"></p>
		</div>
	</div>
</div>
</body>
</html>
